{"version":3,"sources":["auth/auth.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA,6CAAmD;AACnD,2CAA4C;AAC5C,sDAA4C;AAC5C,oCAAoC;AACpC,qCAAqC;AAIrC,IAAa,WAAW,GAAxB;IAMI,YAC6C,eAAiC;QAAjC,oBAAe,GAAf,eAAe,CAAkB;QAJ9E,cAAS,GAAG,WAAW,CAAC;QACxB,cAAS,GAAG,IAAI,CAAC;IAIb,CAAC;IAGL,WAAW,CAAC,IAAU;QAElB,OAAO,GAAG,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,EAAE,EAAE,SAAS,EAAE,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC;IACzE,CAAC;IAMK,YAAY,CAAC,IAAU;;YACzB,MAAM,KAAK,GAAqB,MAAM,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE,EAAE,EAAE,MAAM,EAAE,CAAC,IAAI,EAAE,UAAU,EAAE,QAAQ,EAAE,SAAS,CAAC,EAAE,CAAC,CAAC;YAEjI,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC,OAAO,EAAE;gBACzC,OAAO,KAAK,CAAC;aAChB;YACD,OAAO,KAAK,CAAC;QACjB,CAAC;KAAA;CACJ,CAAA;AA5BY,WAAW;IADvB,mBAAU,EAAE;IAQJ,WAAA,0BAAgB,CAAC,kBAAI,CAAC,CAAA;qCAAmC,oBAAU;GAP/D,WAAW,CA4BvB;AA5BY,kCAAW","file":"auth.service.js","sourcesContent":["import { InjectRepository } from \"@nestjs/typeorm\";\nimport { Injectable } from \"@nestjs/common\";\nimport { User } from \"../model/user.entity\";\nimport * as jwt from \"jsonwebtoken\";\nimport { Repository } from \"typeorm\";\n\n/* 认证服务组件，具有创建token、验证有效载荷的作用 */\n@Injectable()\nexport class AuthService {\n\n    /* 密钥、超时可配置 */\n    secretKey = \"secretKey\";\n    expiresIn = 3600;\n\n    constructor(\n        @InjectRepository(User) private readonly usersRepository: Repository<User>\n    ) { }\n\n    /* 使用有效载荷(用户对象)，创建jsonwebtoken */\n    createToken(user: User) {\n        /* 默认的密钥 */\n        return jwt.sign(user, this.secretKey, { expiresIn: this.expiresIn });\n    }\n\n    /*\n    验证有效载荷方法，这一步时，passport已经将token解密，还原出了生成token的有效载荷\n    而且此时，到这一步，说明解密成功，没有超时，这里只需要加入验证有效载荷的逻辑\n     */\n    async validateUser(user: User): Promise<boolean | User> {\n        const exist: User | undefined = await this.usersRepository.findOne(user.id, { select: [\"id\", \"userName\", \"status\", \"recycle\"] });\n        /* 如果指定用户不存在、禁用、在回收站中，则验证不通过 */\n        if (!exist || exist.status || exist.recycle) {\n            return false;\n        }\n        return exist;\n    }\n}\n"]}